<!DOCTYPE html>
<html>

<head>
    <title>Anonymous Chat App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style/style.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <!-- <script type="text/javascript" src="js/client.js"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <!-- <script type="text/javascript" src="js/script.js"></script> -->
</head>

<body>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.2/js/toastr.min.js"></script>

    <div class="topnav">
        <span style="float: left;">
            <img src="img/logo.jfif" alt="Logo" height="70px">
        </span>

        <a href="/">chat123</a>

        <div class="topnav-right" style="margin-right: 25px;">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a class="active" href="/">Chat with someone</a>
            <span
                style="padding: 15px; padding-top: 31px; font-size: 20px; display: inline-flex; align-items: center; color: white;">
                Connected users: <span id="users"> </span>
            </span>

        </div>
    </div>

    <div id="username_container" style="width: 40%;">
        <div id="background">
            <div>
                <!-- <img id = "left_giraffe" src="img/giraffe_1.png"> -->
            </div>
            <div>
                <!-- <img id = "right_giraffe" src="img/giraffe_2.png"> -->
            </div>
            <div>
                <!-- <img id = "heart" src="img/heart.png"> -->
            </div>
        </div>
        <div id="main_container">
            <div id="title">
                <div>
                    <!-- <img id = "title_img" src="img/title.png"> -->
                </div>
                <div>
                    <!-- <img id = "subtitle_img" src="img/subtitle.png"> -->
                </div>
            </div>
            <div id="username_box">
                <form action="">
                    <div>
                        <input id="nickname" autocomplete="off" value="Stranger" placeholder="Stranger" />
                    </div>
                    <div>
                        <button id="join_chat">You can have a small talk here.</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="waiting_container" style="width: 40%">
        <div id="waiting_image">
            <!-- <img src="img/waiting.png"> -->
        </div>
        <div id="waiting_title">
            <p>Connecting to a stranger. Please wait.</p>
        </div>
    </div>

    <div id="chat_box" style="display: none;">
        <div id="chat_container">
            <!-- <p id="partner_status"></p> -->
            <ul id="messages" style="z-index: 0;"></ul>
            <!-- <div class="alert alert-info" id="alert_template"
                style="display: none; margin: auto; width: 30%; font-size: xx-large; height: 30px; padding-top: 350px; color: blue;">
                <button type="button" class="close"> </button>
            </div> -->
            <form action="">
                <input id="chat_message" autocomplete="off" />
                <button>Send</button>
                <button type="button" id="plus" class="collapsible" style="font-size: larger; margin-bottom: 0px;"
                    onclick="myplusfunction()">+</button>
            </form>
            <div>
                <div class="other_buttons" id="other_buttons">
                    <span id="send_photo"
                        style="display: none; margin-left: -200px; display: inline-block; z-index: 1; margin-top: 450px;">
                        <button style="margin-right: 300px;">
                            <input type="file" id="image_btn" accept="image/*" style="display: none;">
                            <label for="image_btn"> Send Photo </label>
                        </button>
                    </span>
                    <span id="request_photo"
                        style="margin:0px; margin-left: 500px; display: inline-block; margin-top: 450px; margin-bottom: 10px;">
                        <button class="request_photo_button" style="margin-right: 30px;" id="request_photo_button_id">
                            Request Photo
                        </button>
                    </span>
                    <span id="end" style="margin:0px; display: inline-block; margin-left: 500px; ">
                        <button>
                            <a href="/" style="text-decoration: none; color: white;"> End Chat </a>
                        </button>
                    </span>
                </div>
            </div>


        </div>
    </div>

    <script>
        function myplusfunction() {
            var x = document.getElementById("other_buttons");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }
    </script>

    <script>
        /*********************************
         *
         * SOCKET IO ON THE CLIENT SIDE
         */

        toastr.options = {
            "debug": false,
            "positionClass": "toast-bottom-center",
            "onclick": null,
            "fadeIn": 300,
            "fadeOut": 1000,
            "timeOut": 5000,
            "extendedTimeOut": 1000
        }

        $(document).ready(function () {

            var socket = io();
            var isMatched = false;

            var $chatForm = $('#chat_container form');
            var $chatMessage = $('#chat_container #chat_message');
            var $partnerStatus = $('#chat_container #partner_status');
            var $messageContainer = $('#chat_container #messages');

            var $usernameForm = $('#username_container #username_box form');
            var $nickname = $('#nickname');

            var $usernameContainer = $('#username_container');
            var $waitingContainer = $('#waiting_container');
            var $chatContainer = $('#chat_container');

            var $chatPair = [];
            var $partnerName;

            $usernameContainer.show();
            $waitingContainer.hide();
            $chatContainer.hide();

            $(request_photo).click(function () {
                if ($chatPair != null) {
                    socket.emit('requestphoto', {
                        pair: $chatPair
                    });
                };
            });

            // Handle the submit event
            // Submit the username
            $usernameForm.submit(function () {
                if ($nickname.val() != '') {
                    socket.emit('new user', $nickname.val());
                    if (isMatched == false) {
                        $waitingContainer.fadeIn(500);
                        $usernameContainer.hide();
                        $chatContainer.hide();
                    } else {
                        $chatContainer.fadeIn(500);
                        $waitingContainer.hide();
                        $usernameContainer.hide();
                    }
                    $nickname.val('');
                } else {
                    // alert('Please enter the correct nickname!');
                }
                return false;
            });

            // $('#image_btn').bind('change', function (e) {
            //     var data = e.originalEvent.target.files[0];
            //     readThenSendFile(data);
            // });

            // function readThenSendFile(data) {

            //     var reader = new FileReader();
            //     reader.onload = function (evt) {
            //         var msg = {};
            //         // msg.username = username;
            //         msg.file = evt.target.result;
            //         msg.fileName = data.name;
            //         io.sockets.emit('base64 file', msg);
            //     };
            //     reader.readAsDataURL(data);
            // }

            // Submit the chatting messages
            $chatForm.submit(function () {
                if ($chatMessage.val() != '') {
                    if ($chatPair != null) {
                        var dataArray = {
                            msg: $chatMessage.val(),
                            nickname: $nickname,
                            pair: $chatPair
                        };
                        socket.emit('send message', dataArray);
                        $chatMessage.val('');
                    }
                } else {
                    alert('Please enter the message!');
                }
                return false;
            });

            // Handle the typing status of user
            $chatMessage.focus(function () {
                socket.emit('typing status', 'typing');
            });

            $(function () {
                $('#image_btn').bind('change', function (e) {

                    if ($chatPair != null) {
                        var dataArray = {
                            msg: $chatMessage.val(),
                            nickname: $nickname,
                            pair: $chatPair
                        };
                        var data = e.originalEvent.target.files[0];
                        var reader = new FileReader();
                        reader.onload = function (evt) {
                            image('me', evt.target.result);
                            socket.emit('user image', evt.target.result);
                        };
                        reader.readAsDataURL(data);
                    }
                });
            });


            // var coll = document.getElementsByClassName("collapsible");
            // var i;

            // for (i = 0; i < coll.length; i++) {
            //     coll[i].addEventListener("click", function () {
            //         this.classList.toggle("active");
            //         var other_buttons = this.nextElementSibling;
            // if (other_buttons.style.display === "block") {
            //     other_buttons.style.display = "none";
            // } else {
            //     other_buttons.style.display = "block";
            // }
            // });
            // }

            // var uploader = new SocketIOFileUpload(socket);
            // uploader.listenOnInput(document.getElementById("siofu_input"));

            // socket.on('user image', image);

            // $(function () {
            //     $('#image_btn').bind('change', function (e) {
            //         var data = e.originalEvent.target.files[0];
            //         var reader = new FileReader();
            //         reader.onload = function (evt) {
            //             image('me', evt.target.result);
            //             io.sockets.emit('user image', evt.target.result);
            //         };
            //         reader.readAsDataURL(data);

            //     });
            // });

            // Get the typing status from the partner
            socket.on('new typing status', function () {
                if ($partnerName != null) {
                    $partnerStatus.text($partnerName);
                }
            });

            socket.on('users', function (users) {
                total_users = users.users;
                console.log("Total number of users are ", total_users);
                document.getElementById("users").innerHTML = total_users;
            });

            // Get the message from server
            socket.on('new message', function (data) {
                if (('/#' + socket.id) == data.id) {
                    $('#messages').append('<li><div class = "right_bubble"><b>' + "Me" + ': </b>' + data
                        .msg + '</div></li>');
                } else {
                    $('#messages').append('<li><div class = "left_bubble"><b>' + "Stranger" + ': </b>' +
                        data.msg + '</div></li>');
                }

                var chatListHeight = $messageContainer.height();
                var formHeight = $chatForm.height();
                var statusHeight = $partnerStatus.height();
                var winHeight = $(window).height();
                var margin = 10 * 2;

                // Scroll to see the last message
                if (chatListHeight + formHeight + statusHeight + margin > winHeight) {
                    var scrollVal = chatListHeight + formHeight + statusHeight + margin - winHeight;
                    $('html, body').animate({
                        scrollTop: scrollVal
                    }, 1000);
                }
            });

            socket.on('new request photo', function (data) {
                if (('/#' + socket.id) == data.id) {
                    // alert("Sent request.");
                    toastr.info("Sent Request");
                    document.getElementById("request_photo_button_id").style.display = "none";
                } else {
                    // alert("Stranger is requesting for your photo.");
                    toastr.info("Stranger is requesting for your photo.");
                    document.getElementById("send_photo").style.display = "block";
                    document.getElementById("request_photo").style.marginTop = "10px";
                    document.getElementById("request_photo").style.marginBottom = "10px";

                }
            });

            socket.on('user image', image);

            // var canvas = $('<canvas width = "500" height = "300"></canvas>');

            function image(from, base64Image) {

                // if (('/#' + socket.id) == data.id) {
                //     // $('#messages').append('<li><div class = "right_bubble"><b>' + "Me" + ': </b>' + data
                //     //     .msg + '</div></li>');
                //     $('#messages').append($('<p>').append($('<b>').text(from), '<img src="' + base64Image + '"/>'));
                // } else {
                //     // $('#messages').append('<li><div class = "left_bubble"><b>' + "Stranger" + ': </b>' +
                //     //     data.msg + '</div></li>');
                //     $('#messages').append($('<p>').append($('<b>').text(from), '<img src="' + base64Image + '"/>'));
                // }

                $('#messages').append($('<p>').append($('<b>').text(from), '<img src="' + base64Image + '"/>'));
                // $('#messages').append('<li><div class = "right_bubble"><b>' + "Me" + ': </b>' + data.msg + '</div></li>');


                // const width = 500;
                // const height = 300;
                // reader.readAsDataURL(e.target.files[0]);
                // reader.onload = function (evt) {
                //     const img = new Image();
                //     img.src = event.target.result;
                //     img.onload = () => {
                //         const elem = document.createElement('canvas');
                //         elem.width = width;
                //         elem.height = height;
                //         const ctx = elem.getContext('2d');
                //         // img.width and img.height will contain the original dimensions
                //         ctx.drawImage(img, 0, 0, width, height);
                //         ctx.canvas.toBlob((blob) => {
                //             const file = new File([blob], fileName, {
                //                 type: 'image/jpeg',
                //                 lastModified: Date.now()
                //             });
                //         }, 'image/jpeg', 1);
                //     }
                //     reader.onerror = error => console.log(error);
                // };

                // $('#messages').append($('<p>').append($('<b>').text(from), '<img src="' + base64Image +
                //     '"/>'));
            }




            // socket.on('user image', function (data){

            //     if (('/#' + socket.id) == data.id) {
            //         $('#messages').append('<li><div class = "right_bubble"><b>' + "Me" + ': </b>' + data.base64Image + '</div></li>');
            //     } else {
            //         $('#messages').append('<li><div class = "left_bubble"><b>' + "Stranger" + ': </b>' + data.base64Image + '</div></li>');
            //     }

            //     var chatListHeight = $messageContainer.height();
            //     var formHeight = $chatForm.height();
            //     var statusHeight = $partnerStatus.height();
            //     var winHeight = $(window).height();
            //     var margin = 10 * 2;

            //     // Scroll to see the last message
            //     if (chatListHeight + formHeight + statusHeight + margin > winHeight) {
            //         var scrollVal = chatListHeight + formHeight + statusHeight + margin - winHeight;
            //         $('html, body').animate({
            //             scrollTop: scrollVal
            //         }, 1000);
            //     }
            // });

            // function image (base64Image) {
            //     if (('/#' + socket.id) == data.id) {
            //         $('#messages').append('<li><div class = "right_bubble"><b>' + "Me" + ': </b>' + base64Image + '</div></li>');
            //     } else {
            //         $('#messages').append('<li><div class = "left_bubble"><b>' + "Stranger" + ': </b>' + base64Image + '</div></li>');
            //     }
            //     var chatListHeight = $messageContainer.height();
            //     var formHeight = $chatForm.height();
            //     var statusHeight = $partnerStatus.height();
            //     var winHeight = $(window).height();
            //     var margin = 10 * 2;

            //     // Scroll to see the last message
            //     if (chatListHeight + formHeight + statusHeight + margin > winHeight) {
            //         var scrollVal = chatListHeight + formHeight + statusHeight + margin - winHeight;
            //         $('html, body').animate({
            //             scrollTop: scrollVal
            //         }, 1000);
            //     }

            // }


            socket.on('chat pair', function (data) {
                if (data) {
                    $chatPair = data;
                    if (('/#' + socket.id) == $chatPair[0].id) {
                        $partnerName = $chatPair[1].name;
                    } else if (('/#' + socket.id) == $chatPair[1].id) {
                        $partnerName = $chatPair[0].name;
                    }
                }
            });

            socket.on('matching status', function (data) {
                if (data) {
                    $messageContainer.empty();
                    if (data == 'waiting') {
                        console.log('waiting');
                        $partnerName = null;
                        isMatched = false;
                    } else if (data == 'matched') {
                        console.log('matched');
                        alert("User Connected.");
                        // $("#connected").show();
                        // setTimeout(function() { $("#connected").hide(); }, 5000);
                        document.getElementById("chat_box").style.display = "block";
                        document.getElementById("other_buttons").style.display = "none";
                        document.getElementById("request_photo_button_id").style.display = "block";
                        document.getElementById("send_photo").style.display = "none";

                        $("#alert_template button").after('<span>A stranger connected!</span>');
                        $('#alert_template').fadeIn('slow');
                        setTimeout(function () { // this will automatically close the alert and remove this if the users doesnt close it in 5 secs
                            $("#alert_template").remove();
                        }, 5000);

                        if ($partnerStatus != null) {
                            $partnerStatus.text($partnerName);
                        }
                        isMatched = true;
                    }

                    if (isMatched == false) {
                        $waitingContainer.fadeIn(500);
                        $chatContainer.hide();
                        $usernameContainer.hide();
                    } else {
                        $chatContainer.fadeIn(500);
                        $waitingContainer.hide();
                        $usernameContainer.hide();
                    }
                }
            });
        });
    </script>

</body>

</html>